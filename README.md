# Doubly-Robust Machine Learning Causal Estimation of Pathway Activity Effects in Breast Cancer Stage Progression and Survival

- Authors: Amos Okutse, Ian Liu, Man-Fang Liang

## Overview

This repository implements the analysis pipeline for the paper "Doubly-Robust Machine Learning Causal Estimation of Pathway Activity Effects in Breast Cancer Stage Progression and Survival." Using TCGA BRCA data, the workflow estimates the causal effect of pathway activity scores (GSVA) on two outcomes:

- **Tumor stage progression** (early vs late)
- **Overall survival** (time-to-event)

Both analyses apply **doubly robust (DR) / double machine learning (DML)** estimators with cross-fitting to reduce bias and overfitting, while using modern ML models as nuisance learners.

## Repository Structure

- `data/`: Input data files (TCGA BRCA exports)
- `scripts/`: End-to-end analysis scripts and helper utilities
  - `methods_tumor_stage.R`: DR estimation for tumor stage progression
  - `methods_survival.R`: DR estimation for survival outcomes
  - `helper.R`, `survival_helpers.R`: shared utilities and survival-specific helpers
- `results/`: Output figures, tables, and summaries generated by the scripts
- `README.md`: Project documentation

## Data Inputs

The scripts expect the following files in `data/`:

- `data_clinical_patient.txt`
- `data_clinical_sample.txt`
- `data_mrna_illumina_microarray.txt`
- `data_methylation_promoters_rrbs.txt`
- `data_mutations.txt`

These files are available from cBioPortal (TCGA BRCA). If you download data yourself, rename files to match the names above and place them under `data/`.

## Methods Summary

### 1) Tumor Stage Progression (`scripts/methods_tumor_stage.R`)

- **Outcome**: binary tumor stage (early vs late) derived from clinical tumor stage
- **Treatment**: GSVA pathway activity score for a selected pathway
- **Key steps**:
  - Clean and merge clinical sample + patient data
  - Filter and impute expression matrix; align common samples
  - Stratified train/validation/test split by tumor stage
  - Identify DEGs (limma-voom) on training split
  - GSVA-driven pathway ranking (MSigDB C2:CGP, fallback to Hallmark)
  - Assemble covariates (clinical + mutation + methylation summaries)
  - DR estimation with cross-fitting using:
    - DR-GLMNET (penalized logistic / linear models)
    - DR-RF (random forest classification / regression)
    - DR-BART (Bayesian additive regression trees)
  - Sensitivity analysis with clinical-only covariates

### 2) Survival Analysis (`scripts/methods_survival.R`)

- **Outcome**: overall survival time and event status
- **Treatment**: GSVA pathway activity score for a selected pathway
- **Key steps**:
  - Clean and merge clinical data; align with expression data
  - Stratified train/validation/test split by event status
  - Compute RMST pseudo-outcome (tau = 120 months)
  - GSVA-driven pathway ranking (MSigDB C2:CGP, fallback to Hallmark)
  - Assemble covariates including mutation and methylation summaries
  - DR estimation with cross-fitting using survival-specific learners:
    - DR-Cox (Cox PH model for RMST prediction)
    - DR-RSF (Random Survival Forest)
    - DR-GLMNET (RMST pseudo-outcome regression)
    - DeepSurv is present but commented out (requires `keras`)
  - Sensitivity analysis with clinical-only covariates

## Requirements

- R (tested with recent 4.x versions)
- Core CRAN/Bioconductor packages used across the pipeline include:
  - `data.table`, `dplyr`, `survival`, `glmnet`, `ranger`, `randomForestSRC`
  - `msigdbr`, `GSVA`, `limma`, `matrixStats`, `pROC`
  - `ggplot2`, `ggrepel`, `ggpubr`, `cowplot`, `VennDiagram`, `ggvenn`

If a required package is missing, the scripts will stop with a message listing the missing packages.

## Running the Analyses

From the project root in R:

```r
setwd("/path/to/DR-ML-Estimation-of-ACE")

# Tumor stage analysis
source("scripts/methods_tumor_stage.R")

# Survival analysis
source("scripts/methods_survival.R")
```

Notes:
- Both scripts perform their own preprocessing and will generate figures/tables under `results/`.
- The workflows can be compute-intensive due to cross-fitting, GSVA scoring, and model training.

## Outputs

### Tumor Stage (`methods_tumor_stage.R`)

- `results/5-fold-results/causal_effects_summary.csv`
- Figures and plots under:
  - `results/5-fold-results/`
  - `results/5-fold-results/plots/`

### Survival (`methods_survival.R`)

- DML estimates and sensitivity tables:
  - `results/survival/tables/dml_estimates_by_split.csv`
  - `results/survival/tables/dml_estimates_full_data.csv`
  - `results/survival/tables/sensitivity_clinical_only.csv`
- Performance tables:
  - `results/survival/tables/tableS_outcome_model_performance.csv`
  - `results/survival/tables/tableS_rmst_prediction_performance.csv`
  - `results/survival/tables/tableS_treatment_model_performance.csv`
- Summary text:
  - `results/survival/summary/analysis_summary.txt`
- Figures:
  - `results/survival/figures/fig1-fig5_*.png`
  - `results/survival/figures/figS1-figS4_*.png`

## Contact

- Amos Okutse: `amos_okutse@brown.edu`
- Ian Liu: `ian_y_liu@brown.edu`
- Man-Fang Liang: `man-fang_liang@brown.edu`
